---

# This playbook interacts with the bastion node.

# It includes installation of `terraform` - a tool required to
# orchestrate the cluster. Binary tools are installed in
# the user's `~/bin` directory if they don't already exist.

- hosts: bastion
  gather_facts: no

  tasks:

  # --------
  # Preamble
  # --------

  # Wait for the the host...
  - name: Wait for SSH
    wait_for:
      host: "{{ ansible_ssh_host }}"
      port: 22
      search_regex: OpenSSH
      delay: 5
    vars:
      ansible_connection: local

  - name: Gathering facts
    setup:

  - name: Create remote_tmp
    file:
      path: "{{ ansible_env.HOME }}/.ansible/tmp"
      state: directory
      mode: 0755

  # And files...

  - name: Install SSH private key
    copy:
      src: "{{ lookup('env','HOME') }}/.ssh/{{ keypair_name }}"
      dest: "{{ ansible_env.HOME }}/.ssh/id_rsa"
      mode: 0600

  #Â Default environment variables

  # The path to the deployment-specific directory
  # is relative to this (ansible/bastion) directory.
  - name: Install bastion.sh
    copy:
      src: "../../openshift/inventories/{{ deployment }}/bastion.sh"
      dest: "/etc/profile.d/bastion.sh"
      mode: 0644
    become: true

  # ----------------
  # The Orchestrator
  # ----------------

  - name: Clone the orchestrator
    git:
      repo: 'https://github.com/InformaticsMatters/okd-orchestrator.git'
      dest: "{{ ansible_env.HOME }}/okd-orchestrator"

  # --------
  # Packages
  # --------

  - name: Install the libselinux-python package
    yum:
      name: libselinux-python
      state: present
