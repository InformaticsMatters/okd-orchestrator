---

# This playbook interacts with the bastion node.

# It installs the user's OpenShift-specific tools and files
# assuming a base Bastion image is being used on the cloud-provider.

- hosts: bastion
  gather_facts: no

  tasks:

  # --------
  # Preamble
  # --------

  # Wait for the the host...
  - name: Wait for SSH
    wait_for:
      host: "{{ ansible_ssh_host }}"
      port: 22
      search_regex: OpenSSH
      delay: 5
    vars:
      ansible_connection: local

  - name: Gathering facts
    setup:

  - name: Create directories
    file:
      path: "{{ ansible_env.HOME }}/{{ item }}"
      state: directory
      mode: 0755
    loop:
    - .ansible/tmp
    - okd-orchestrator

  - name: Install the libselinux-python package
    yum:
      name: libselinux-python
      state: present

  # Add files...

  - name: Install SSH private key
    copy:
      src: "../../{{ keypair_name }}"
      dest: "{{ ansible_env.HOME }}/.ssh/id_rsa"
      mode: 0600

  #Â Default environment variables

  # The path to the deployment-specific directory
  # is relative to this (ansible/bastion) directory.
  - name: Install bastion.sh
    copy:
      src: "../../openshift/inventories/{{ deployment }}/bastion.sh"
      dest: "/etc/profile.d/okd.sh"
      mode: 0644
    become: yes

  # ---------------------
  # Copy the Orchestrator
  # ---------------------

  # Here we copy crucial parts of the orchestrator to the Bastion.
  # We will checkout the OpenShift Ansible repository directly on the bastion
  # when `create.py` is run so we just copy crucial files and directories here.
  - name: Copy orchestrator directories
    copy:
      src: "../../{{ item }}/"
      dest: "{{ ansible_env.HOME }}/okd-orchestrator/{{ item }}"
    loop:
      - ansible
      - deployments
      - openshift
      - utils

  # Now executable parts of the Orchestrator
  - name: Copy orchestrator modules
    copy:
      src: "../../{{ item }}"
      dest: "{{ ansible_env.HOME }}/okd-orchestrator/{{ item }}"
      mode: 0755
    loop:
      - create.py
      - render.py

  # -----------------
  # Install OpenShift
  # -----------------

  # Continue to install OpenShift (using the cloned 'create' utility)
  # if install_openshift is set.
  - name: Create (Install OpenShift)
    shell: ./create.py --openshift --auto-acknowledge
    args:
      chdir: okd-orchestrator
    when: install_openshift|lower == 'yes'
